# 自动化打包免密部署博客至阿里云

## 背景

之前博客是在 Github 平台进行托管，但因为它只接受 https 发送的请求，导致我很多存在自己服务器的图片都没法访问，那时候的服务器还是 http 请求，并且还是 IP+端口 的方式，所以打算迁移博客到我的阿里云服务器中。

之前也是有一键部署的功能的，原理其实没区别，都是把本地打包的文件提交到远程服务器指定启动地址中。只不过用 GitHub 中直接使用 git 强制推送即可。

推送文件到阿里云服务器就需要一些 Linux 的命令了，和 git 也差别不大。

```bash
# 生成静态文件
npm run docs:build

# 进入生成的文件夹
cd docs/.vuepress/dist

echo "正在提交 commit 到本地"
git init
git add ./
git commit -m 'deploy'

# 因为在 dist 文件夹中，所以 -f 强行推送没毛病
# 如果发布到 https://<USERNAME>.github.io/<REPO>
echo "正在推送到远程仓库,请耐心等待..."
git push -f git@github.com:Xguihur/[仓库名] master:[分支名] # 使用 ssh 推送终于成功了，为什么 https 无法成功呢？--- 原因是之前存了很多图片内存很大，现在把图片抽离出来后传输速度也很快了！

cd -
```

## 实际操作

### 参考资料

[阿里云社区中关于上传本地文件至服务器指定位置的教程，很易懂](https://help.aliyun.com/zh/ecs/how-do-i-upload-files-and-folders-to-a-linux-instance-by-using-ssh)

其中还搜索了关于如何实现免密传输文件，其实也就是使用 公私钥 实现此功能。因为之前用过，所以我知道有这种方法，只是具体怎么做忘记了，经过实践发现又巩固了一块知识！

### 一键部署的自动化脚本

```bash
# 确保脚本抛出遇到的错误
set -e

# 生成静态文件
npm run docs:build

# 进入生成的文件夹
cd docs/.vuepress

echo "正在推送至阿里云服务器，请耐心等待"
scp -r dist [username]@[IP]:[object_catolog]

cd -
# 实现起来比用 git 传输还简单，都不需要提交仓库代码之类的了
```

以上脚本直接使用 bash 相关的命令执行即可，它就会自动打包并且将文件上传到阿里云服务器，只不过这种方式只能小文件使用了，如果需要断点续传之类的需求，那就要进一步开发了！

**注意：** 使用以上方式上传文件时，终端中会弹出需要验证密码的提示框，你需要输入密码登录服务器，他才会自动继续下一步代码的推送

### 公私钥免密登录

执行脚本就是为了省事，你这还得等它终端弹出密码输入框，输入完才进行后续流程，这像什么话！

于是就去了解怎么样实现用 密钥 的方式登录阿里云，从而推送代码时不需要再校验密码

我有这个概念，但脑子里很模糊，以为很复杂，但实际操作下来，发现还可以！之前只是自己对于未知的恐惧而已！

> 具体流程

实际上如果用终端登录阿里云服务器，也是要验证密码的。如这行命令： `ssh root@[IP]`。执行完后就需要校验密码，输入正确后就成功登录阿里云了。

上面的场景中，用 密钥 的方式进行登录要怎么做呢？

1. 本地创建生成公私钥。如果本地有，那就不需要再创建，找到对应的文件，拷贝公钥即可。`一般本地的在:C:\Users\name\.ssh` 中能够找到对应的 .pub 文件
2. 复制 .pub 文件中的所有内容，粘贴到阿里云服务器中统一管理密钥的地方。`一般在阿里云服务器中的：~/.ssh/authorized_keys` 中。
   1. 直接打开那个 *authorized_keys* 文件，在里面追加自己复制的公钥。**注意：** 一个公钥独占一行，不要和其他的公钥搞混了！

> 这里有一个细节，如何将本地的公钥拷贝到服务器的文件中呢？

我本来想用 vim 秀一把操作的，但本地复制了，到阿里云服务器使用 vim 的 p 进行拷贝 却提示剪切板没有内容，很不理解为什么！

后面看了一种方法是用 echo [xx] >> [file] 实现追加，但我这公钥这么长不太好追加啊！
目前是使用了宝塔的可视化界面直接到文件中拷贝，用代码应该也可以，就用 scp 配置追加的选项，一会试试看。

> 好好好，GPT好活当赏，以下为GPT提供，又理解了一点 Shell 相关的知识了：

**GPT start:**如果您想要使用 Linux 命令将一段文本插入到远程服务器的某个文件中，您可以使用 SSH 和远程命令执行来实现。以下是一种常见的方式 ：

```bash
echo "要插入的文本" | ssh <username>@<server-ip> "cat >> /path/to/file"
```

将 `<username>` 替换为您在服务器上的用户名，将 `<server-ip>` 替换为目标服务器的 IP 地址，将 `/path/to/file` 替换为目标文件的路径。

在上述命令中，`echo` 命令用于输出要插入的文本内容，通过管道 `|` 将输出传递给 SSH 命令。SSH 命令将远程连接到服务器，并在远程服务器上执行 `cat >> /path/to/file`，将输入追加写入到指定文件中。

请确保您具有适当的权限来执行追加写入文件的操作，并且目标文件的路径是正确的。另外，您需要输入您的远程服务器密码以进行身份验证，除非之前已经配置了免密登录。

如果您需要插入的文本非常长或包含特殊字符，可以将文本内容保存到一个文件中，然后使用 `cat` 命令读取该文件内容并进行插入。

```bash
cat local_file.txt | ssh <username>@<server-ip> "cat >> /path/to/file"
```

上述命令中，`local_file.txt` 是包含要插入的文本的本地文件路径。命令将该本地文件内容通过 SSH 命令传递到远程服务器，并追加写入指定文件中。

通过以上方式，您可以实现将文本内容插入到远程服务器的文件中。**:GPT end**

> 实测AI提供的方法（*不得不佩服AI确实是对于初学者有很大帮助，这不实践一下又收获不少知识*）：

1. 我在本地新建了一个 text，随便写了点内容。
2. 接着在服务器中的其中一个文件夹随便新建了一个 test 文件，里面也随便写了点东西。
3. 然后执行命令：`cat local_file.txt | ssh <username>@<server-ip> "cat >> /path/to/file"` *（记得修改里面对应的参数进行尝试，不过如果你想要傻瓜式操作指南，可以联系我出一个超级友好的拷贝就能用的版本）*

4. 可以发现确实！我在本地的 text 文件中写入的内容真的被写入到 服务器的 test 文件中了！

**但是：** 有一个问题，以上的方式是直接在后面追加，也就是说往文件的最后的那个位置进行追加文本，如果写那个文件的人没有最后留空一行的习惯，那可能我们的公钥就无法生效了！

于是去了解了如何在拷贝文本的同时，自动换行！*（一开始自己想的是进入对应的文本中，手动添加一个换行哈哈哈）*

---

OK，不出意料还是 GPT 老哥，经过我几个问题的拉扯下，他终于给出了满意的结果，并且经过测试确实是会在前面进行一次换行！这样就完美解决了我的需求，下次大家拷贝公钥到服务器中也可以用这种方式了！甚至可以将下面这行代码也写成一个脚本以后用呢！

以下是出自 GPT 之手：

**GPT start：**要使用 `cat` 命令通过 SSH 将本地文件内容插入到远程服务器文件，并另起一行插入文本，您可以使用以下方法：

```bash
echo -e "\n$(cat local_file.txt)" | ssh <username>@<server-ip> "cat >> /path/to/file"
```

这个命令首先使用 `cat` 命令读取本地文件 `local_file.txt` 的内容，并通过命令替换 `$(cat local_file.txt)` 将其插入到 `"\n"` 的后面。 `"\n"` 表示在文本插入位置另起一行。

然后，使用 `echo -e` 命令将形成的新文本包装在双引号中，并使用管道 `|` 将其传递给 SSH 命令。

最后，SSH 命令通过远程连接将另起一行插入的文本追加写入到远程服务器的指定文件中。**：GPT end** 

## 总结

本来以为就是简简单单记录一下 自动化脚本 和 免密登录，没想到后面不甘于受宝塔的文件上传限制，又在一边写一遍实践中学到了不少 Shell 相关的玩法，接下来对 Linux 更加有自信了哈哈哈

而且确实是学到了不少内容，例如 echo 、cat 、>> 追加符、管道、甚至是 echo -e 的转义等一系列的用法！感恩辉哥，是因为想着不能给自己挖坑第二天被辉哥说，所以再进一步去研究了一下！