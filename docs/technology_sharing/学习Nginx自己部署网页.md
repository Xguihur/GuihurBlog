# 学习 Nginx 自己配置网页

## 背景

在某一个周末，我终于开始捣鼓 域名、备案、SSL 相关的知识了！

>  开始搞这些是因为那两天一直被堆积以来的 Todo 噩耗着，直到影响到度过一个美好周末！于是就不在退缩，把对我压力最大的几个东西，一个个去处理（阿里云备案、最近完成的业务组件库封装逻辑、整理博客），即使是很抗拒，我也用番茄钟去逼自己完成这些。就像是跑步一样，精神告诉自己快放弃，但事实上坚持下去对自己才是最好的真正有益的！

根据我多次观望的经验，备案域名在阿里云的帮助下能够很方便，不需要自己去公安局这么麻烦！于是直接狠一把开干!

经过一番折腾，买到了域名、申请了备案，在等等备案审核期间还白嫖了三个月的 SSL 来玩 https 证书，没想到一下就搞好了！`（具体经过看我另一篇详细经过的文章）` 

因为感受到一点点的进步以及过程中不断有成功的反馈，让我异常兴奋！以至于干到晚上三点，第二天起床依然很有精神！哈哈哈，完全没有熬夜带来的负罪感！（虽然在持续两天后，即使是有技术带来的兴奋，也挡不住身体真的变差。尤其是在打球和跑步过程中能够明显感受得到！还是少熬夜的好啊~）

> 关键地方来了：

第二天晚上和辉哥吃饭时，我还是控制不住地和他分享我周末的成果（后来我自己认为是值得的，让我更加进步）。之后辉哥简单评论了几句后，和我说了一个很深刻的话：`你做博客是为了面试还是为了自己玩，如果是自己玩那你用工具没所谓。但你要是想面试加分，你不懂原理那就是给自己挖坑！` 

于是我就立志要把模棱两可的 Nginx 配置去琢磨明白，自己玩一遍！但没想到过程中还有很多奇妙的收获哈哈哈哈！太值了~

于是回家忙完该忙活的，虽然没多少时间了，但我也还是找了相关资料学习，毕竟自己也懂得差不多了，只是比较模糊罢了！

## 学习过程

### 关键参考资料

[Nginx部署前端项目-B站视频](https://www.bilibili.com/video/BV1fG4y1a7Sv/?spm_id_from=333.1007.top_right_bar_window_history.content.click&vd_source=6e82c2bc475d3cb127e47892e43f7b86)

[Nginx代理转发-B站视频](https://www.bilibili.com/video/BV18a411G7UM/?spm_id_from=333.788.top_right_bar_window_history.content.click&vd_source=6e82c2bc475d3cb127e47892e43f7b86)

[Nginx 中 try_files 作用的理解-掘金大佬的博客-受益匪浅](https://juejin.cn/post/7090038118841057293)

### 开始实践

> Nginx 部署前端项目

因为我之前玩过本地 Nginx ，但玩完后，就对服务器上玩同样的内容没了兴趣。所以为了避免时间的浪费，我直接在 阿里云 上玩 Nginx 配置！

看过视频后大致知道 Nginx 的配置原理，所以自己能够不严格按照视频的走，而是想想自己想做什么，大概要怎么做达到学习的目的。也算是一种变通吧！（虽然辉哥一直说我不太懂变通md，那我就学会变通就好了！引用看彦祖打球说的一句话：`拜师学艺，一点就通,看我这悟性！`）

:rofl: 一开始我在 阿里云上想执行 `nginx -s start` 来启动 Nginx 进行测试，但一直说找不到命令，进入到它的 文件夹也似乎没找对，索性就不强求了！至少知道是 安装Nginx 成功了。（估计后面还得花时间把这块弄明白，不可能留一点遗憾的！:fire_engine: ）

---

后面直接去玩核心的 配置文件！自己没找到对应 Nginx 配置文件放在哪里，于是就上网搜索：“宝塔安装的 Nginx 配置文件在哪？”

很容易就找到了对应的配置文件地址，它是使用了模块化的思想拆分一个个的页面单独配置，最后在 主配置文件中使用 **include + 类似正则表达式** 匹配所有的配置文件。

因为我的服务器在宝塔中配置了两个网站了，所以算是有的参考。一个是 Node 文件上传的前端页面，另外一个就是我的个人博客了，并且还配置了 SSL 证书认证（这一块之后手动配置也得去了解一下了，毕竟是为了面试不给自己挖坑！）。

---

找到了配置文件就很好办了，我自己看了视频的理解，对于 Nginx 配置网站其实只需要设置好：**端口、域名、启动文件的地址** 这三个东西，就算是完成了一次配置！

理论明白了，就开始实践！自己也创建一个配置文件，模板直接拷贝其中一个网站的（无SSL），接着自己修改 端口、域名，启动文件暂时就和他们一样，看看能不能正常访问！配置好后，我就去 阿里云 服务器开启端口安全组，于是在这就吃了一个暗亏！我以为开启了 阿里云 的安全组就 OK 了，没想到宝塔还有一层安全组 :cry: ，得把 宝塔 的安全组也开启对应的端口，才能正常访问网站！

经过以上实践，我发现我得理论得到了验证！于是本地写了一个 HTML，在文件目录中新建了一个文件夹，存放这个 HTML。然后回到配置文件中，修改对应的路径，再次点击访问，ok，非常NICE！成功访问了网页！，心情无比的愉悦！

![自己新增的配置文件](http://8.134.197.161:3000/api/images/blog/image-1710868657398.png)

> Nginx 代理转发 （其实就是之前背的什么反向代理、正向代理的实际操作，碰巧让自己学会了哈哈哈）

完成了上面的操作后，辉哥的要求也是基本上达到了，他那个`你知道怎么配置Nginx部署网站吗？` 的问题算是已经解决了，但高兴之余还是意犹未尽！就把另外一个看的视频的内容也进行一下实践！

---

我自己又新建了一个文件，设置新的端口、新的域名，但没有再写新的文件了，访问的是之前那个测试的 HTML 文件地址。这一次就感觉是轻车熟路，一下就搭建好了！

在接下来的实践过程中，我发现宝塔的模板中是直接在 server 对象中写 root 表示对应的路径的，但视频教程的路径是写在 location 对象中的。刚开始不知道什么意思，就照着改成了 location 的形式去测试，发现也能正常访问我的那个 HTML 文件，就继续代理相关的事情了。

`现在倒是知道了那个 location 的意思，虽然没有看资料，但我感觉自己猜的没错`：

```conf
server {
	listen **
	server_name www.**.com
	location / {
		index index.html...
		root 对应的目录文件夹地址
	}
}
```

解释一下：

1. location / {} 其实就是对访问这个 **IP+端口** 或者是直接访问这个**域名**，它的 根路径就是 / ，下面的对象就是对这个 路径 进行相关的配置
2. root 呢，就是将 / 重定向为对应的 路径，也就是说，访问这个域名的时候，就会根据 root 的路径进行查找文件
3. index、index.html ... 后面列举一大堆文件，这都是用于匹配的可能的文件。它的执行逻辑是这样的：访问域名 -- 根据 根路径 查找文件 -- 结合根路径和 index 等文件进行一一匹配，如果匹配的文件存在就返回这个文件，如果匹配的文件不存在，就继续往下匹配，直到结束还找不到就返回 404 了
4. 以上都是我的猜想，未经过验证，请大家自行验证，不要盲目相信我。我只是又一次懒惰，留下了之后学习 Nginx 相关配置原理的 Todo 就暂时停止探索了。

---

好了，言归正传，回到 代理转发 的话题中，实际上的代理转发很简单，就是在以上 location 中，index、root 等都去掉，不要了！而是使用一行配置表示要转发到的目标服务器：`proxy_pass [Object-server]` 

我自己尝试了 转发到我自己其他端口的网站中，能够成功访问，并且 IP+端口 在浏览器的 URL 栏上还是显示我当前的 IP+端口，而不会改变为 目标服务器 的 IP+端口。这就很妙了，玩法也很多了。我测试了一下，把代理服务器弄成 语雀 的官网，发现也能够正常访问过去，URL 上还是我自己的服务器 IP ！

到这，我忽然间就发现知识点串联起来了！之前背的什么 代理解决跨域问题、反向代理之类的知识点，一下子好像连起来了一样！这实际上就是把我的阿里云服务器作为了一个中转，由我的阿里云服务器向语雀官网发起请求，**这样就对 语雀官网 屏蔽了我真实的访问客户端 IP 地址**，太秀了这一波，这就给我玩明白了！？

![代理转发到语雀的测试](http://8.134.197.161:3000/api/images/blog/image-1711216607491.png)

> 解决 Vite 文件上传项目中，使用 history 路由造成刷新页面后返回 404 的问题

好好好，在完成以上功能实践后，我发现我所知道的知识点基本都串联起来了，就开始联想还有哪些相关的知识点再串一串！然后想到了这个 index 匹配、代理转发之类的，和我用 Vue、React 开发的项目使用的 history 模式似乎有点关联。并且我的 React 文件上传项目确实是存在这个问题，就想着能不能给他优化了！

上网搜了一下解决 单页面应用 history 模式的方法，确实找到了 Nginx 配置的实现方法！（这个在看上面的视频教程的时候也有看他演示过，那时候其实就有所联想了，没想到确实是一样的原理）

解决方法其实就是在 location 中加一行配置：`try_files $URI $URI/ /index.html`

实践后，发现这个刷新后 404 丢失的问题确实解决了！震撼我，这么简单？！！

![操作具体图片](http://8.134.197.161:3000/api/images/blog/image-1711216697830.png)

于是出于好奇，去了解这行代码具体作用是什么，然后在上文的 **参考资料** 中的掘金那篇文章找到了一些思路，以下是我总结的感悟：

`看了老哥的文章后，大致了解了他这个匹配机制。本质上就是按顺序去查找文件，看看能不能找到，如果都找不到就直接访问最后一个 ：$root/index.html 这是一定能访问到的，毕竟是页面启动文件。而这就是关键所在 vue、react 这些是单页面文件，于是无论什么路由，刷新后都是指向这个 index.html 文件！！！接着，vue 或者 react 内部根据自己的路由中的 path 进行组件匹配，这就涉及到它内部的路由了！！！一瞬间感觉都串起来了！`



**try_files** 的实际匹配规则还有待了解一下，目前通过一个博客还是模棱两可的不够清晰。文中是这么说的：

```perl
try_files static/ $uri @fallback;
index index.html index.php;
#依次检测$root/static/index.html,$root/static/index.php,$root/$uri是否存在，若不存在则重定向到@fallback。
```

## 结语

至此，这次的 Nginx 之旅算是告一段落了。这次的实践还是收获了不少东西的，特别的对于自信心的提升！在面试的时候我能自信的说出自己搭建博客的过程，以及其中 Nginx 的配置的一些作用，甚至还能联系到怎么解决 单页面应用中 History 模式页面找不到的问题！

感谢辉哥对我的鼓励，也感谢他耐心的听我说关于技术的话题，并且还会认真地和我沟通，无论是让我认清事实，还是鼓励我，对我都是很大的帮助！甚至他只是笑一笑，听我发泄输出一波最近的收获，我也非常开心！这一刻忽然感觉到了正反馈的收获，有人带是真的快乐和开心啊！

最后以 回复以前中二言论 的形式结个尾：`之前说，在遇到路飞之前，先成为路飞。现在似乎遇到了人生中其中一个路飞，那我就把握好机会，安心地做一个努力奋斗的索隆吧！`



---

>  2024-03-24 再次探索

我以为上次到上次那里就已经结束了，但后续还是发现了 bug！

也就是我没有修改任何的文件，但访问服务器地址却打开的是空白网页，查看网页 f12 也是资源访问错误的问题，还去搜了一下 vite 打包资源找不到的问题，试了相关方法也是没有用。

后来去问辉哥，和他描述了这个问题。他和我说这种情况就只能具体情况具体分析了，但你应该从源头去思考那个链路，如果没有修改过文件，就是服务端出了问题。

于是我开始排查：

1. 首先替换 index.html 文件，发现能正常访问，排除服务器被攻击导致崩溃或者端口未开放问题。
2. 接着注释之前配置的 location，还原之前的样子。发现可以正常访问，只是仍然存在刷新丢失路由的问题。
3. 接着慢慢还原，发现加上 try_files 也能正常访问了，但只限于一级路由，也就是如下图片的首页和图表部分。

![文件上传页面图片](http://8.134.197.161:3000/api/images/blog/image-1711216719940.png)

4. 当点击上传中的路由时，因为这时候的路由组成是： `/upload/:type`  。也就是相当于有二级路由了，这时候刷新，页面就会变成空白，查看 浏览器控制台会发现报错了，是资源找不到的问题。

![资源找不到](http://8.134.197.161:3000/api/images/blog/image-1711216731651.png)

5. 接下来对比 charts 的页面进行刷新，发现没有报错，同时 network 中也请求了同一个文件，但路径有些不同。而这也是关键问题所在！

![charts 的资源对比](http://8.134.197.161:3000/api/images/blog/image-1711216746719.png)

6. 可以发现，资源访问错误的那个报错中，路径中多了一个 upload 。我去访问服务器中存放的资源，其实并没有 upload 这个目录的，只有 assets。
   1. 接着继续思考，报错的页面中的 upload 是哪里来的呢？我看了一下这时候的路由，：`/upload:blog` 。OK，我大概知道为什么了，估计是我在项目的打包中配置的资源路径是相对路径。我到项目中一看，发现还真是！将 **base: ./**  改成 **base: /** 就发现成功了！

![vite config](http://8.134.197.161:3000/api/images/blog/image-1711216760842.png)

![success request](http://8.134.197.161:3000/api/images/blog/image-1711216771386.png)

7.  我接着思考，为什么设置 `base: ./ ` 就会捕获到 upload 呢？它是根据什么来设置的呢？为什么不是 `/upload/blog/ ` 呢？以下是自己猜测和分析：
   1. 设置为 **base : ./** 时，base 其实是根据 **Nginx 中的 root 中路径 +当前的 URI 的上一层** 来设置的，例如当前的 URL 是 `http://ip:port/charts` ,那么 base 就是 URI （ /charts ) 的上一层，就是 / 。如果是 `http://ip:port/upload/blog` ，那么 base  就是 `/upload` 。最终打包后访问的资源路径就被替换成 对应的 base 了
   2. 设置 **base: / ** 时，base 就默认是 Nginx 配置的 root 路径。打包后的资源也是被替换成对应的 base 进行请求了。

8. 拓展：root 和 alias：
   1. 之前排查 try_files 的时候，对 Nginx 的 location 设置有了简单的了解。其中有一个比较特别的是 ： root 选项 和 alias 选项。
   2. 我看到一些教程解决 history 的问题用的都是 alias，网上也有对这两者区别进行很详细的解释，我在这简单解释一下，如不清晰请自行去了解，网上的例子很好理解。[参考链接，一个老哥的博客，很清晰](https://nestealin.com/87cffeca/)
   3. root的处理结果是：root路径 ＋ location路径
   4. alias的处理结果是：使用 alias 路径替换 location 路径

## 再次总结

这次的小问题其实就只是一个地方引起的，单纯是打包的时候 base 配置问题，但我排查也用了好长时间，其中也算是学到了一些额外的东西。

例如：Nginx 的 root 和 alias 、排查问题的链路思考、Vite 的配置文件 base 的思考等！还算不错。