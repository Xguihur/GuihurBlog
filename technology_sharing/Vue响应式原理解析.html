<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>💌纵观全局 -- 俯视代码 | Guihur Blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="我的日常个人博客">
    
    <link rel="preload" href="/GuihurBlog/assets/css/0.styles.82efe5de.css" as="style"><link rel="preload" href="/GuihurBlog/assets/js/app.8bb8757a.js" as="script"><link rel="preload" href="/GuihurBlog/assets/js/7.f1c26474.js" as="script"><link rel="preload" href="/GuihurBlog/assets/js/2.70e4b6cf.js" as="script"><link rel="preload" href="/GuihurBlog/assets/js/1.e850f610.js" as="script"><link rel="preload" href="/GuihurBlog/assets/js/47.0951090b.js" as="script"><link rel="prefetch" href="/GuihurBlog/assets/js/10.7f3cc58c.js"><link rel="prefetch" href="/GuihurBlog/assets/js/11.998bbd30.js"><link rel="prefetch" href="/GuihurBlog/assets/js/14.2f88753a.js"><link rel="prefetch" href="/GuihurBlog/assets/js/15.97d18493.js"><link rel="prefetch" href="/GuihurBlog/assets/js/16.74c211db.js"><link rel="prefetch" href="/GuihurBlog/assets/js/17.87fbf99b.js"><link rel="prefetch" href="/GuihurBlog/assets/js/18.1ba5666b.js"><link rel="prefetch" href="/GuihurBlog/assets/js/19.c9672eab.js"><link rel="prefetch" href="/GuihurBlog/assets/js/20.cef40ce1.js"><link rel="prefetch" href="/GuihurBlog/assets/js/21.ff4bba77.js"><link rel="prefetch" href="/GuihurBlog/assets/js/22.255828eb.js"><link rel="prefetch" href="/GuihurBlog/assets/js/23.a8f2e445.js"><link rel="prefetch" href="/GuihurBlog/assets/js/24.8a10a6a7.js"><link rel="prefetch" href="/GuihurBlog/assets/js/25.68f13823.js"><link rel="prefetch" href="/GuihurBlog/assets/js/26.0becbeee.js"><link rel="prefetch" href="/GuihurBlog/assets/js/27.4e3209a7.js"><link rel="prefetch" href="/GuihurBlog/assets/js/28.07c425ee.js"><link rel="prefetch" href="/GuihurBlog/assets/js/29.a0d96603.js"><link rel="prefetch" href="/GuihurBlog/assets/js/3.8ef4d04b.js"><link rel="prefetch" href="/GuihurBlog/assets/js/30.b3e830ef.js"><link rel="prefetch" href="/GuihurBlog/assets/js/31.87b03ce3.js"><link rel="prefetch" href="/GuihurBlog/assets/js/32.b7e03d21.js"><link rel="prefetch" href="/GuihurBlog/assets/js/33.70ff7812.js"><link rel="prefetch" href="/GuihurBlog/assets/js/34.6c030a04.js"><link rel="prefetch" href="/GuihurBlog/assets/js/35.4664bc2e.js"><link rel="prefetch" href="/GuihurBlog/assets/js/36.b79cd8bd.js"><link rel="prefetch" href="/GuihurBlog/assets/js/37.96e4adfb.js"><link rel="prefetch" href="/GuihurBlog/assets/js/38.af5dabea.js"><link rel="prefetch" href="/GuihurBlog/assets/js/39.ae58f3c7.js"><link rel="prefetch" href="/GuihurBlog/assets/js/4.78de5fa6.js"><link rel="prefetch" href="/GuihurBlog/assets/js/40.91a13910.js"><link rel="prefetch" href="/GuihurBlog/assets/js/41.c0049a39.js"><link rel="prefetch" href="/GuihurBlog/assets/js/42.c480a2fd.js"><link rel="prefetch" href="/GuihurBlog/assets/js/43.4c67b160.js"><link rel="prefetch" href="/GuihurBlog/assets/js/44.815cee21.js"><link rel="prefetch" href="/GuihurBlog/assets/js/45.93e58a4e.js"><link rel="prefetch" href="/GuihurBlog/assets/js/46.2e24abda.js"><link rel="prefetch" href="/GuihurBlog/assets/js/48.00b33a16.js"><link rel="prefetch" href="/GuihurBlog/assets/js/49.39b8edca.js"><link rel="prefetch" href="/GuihurBlog/assets/js/5.f2fa280f.js"><link rel="prefetch" href="/GuihurBlog/assets/js/50.16214f22.js"><link rel="prefetch" href="/GuihurBlog/assets/js/51.38c6911d.js"><link rel="prefetch" href="/GuihurBlog/assets/js/6.734159d4.js"><link rel="prefetch" href="/GuihurBlog/assets/js/8.9514a870.js"><link rel="prefetch" href="/GuihurBlog/assets/js/9.dc8337af.js"><link rel="prefetch" href="/GuihurBlog/assets/js/vendors~docsearch.86fb114e.js">
    <link rel="stylesheet" href="/GuihurBlog/assets/css/0.styles.82efe5de.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Guihur Blog</h3> <p class="description" data-v-59e6cb88>我的日常个人博客</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/GuihurBlog/" class="home-link router-link-active"><img src="/GuihurBlog/logo1.png" alt="Guihur Blog" class="logo"> <span class="site-name">Guihur Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/GuihurBlog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      桂花的关联网站
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Xguihur" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.yuque.com/luffy-j7ldi" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  语雀
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://47.120.44.145:3000/#/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  算法博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/Xguihur/GuihurBlog.git" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-查看源码"></i>
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>12</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/GuihurBlog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      桂花的关联网站
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Xguihur" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.yuque.com/luffy-j7ldi" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  语雀
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://47.120.44.145:3000/#/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  算法博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/Xguihur/GuihurBlog.git" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-查看源码"></i>
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/GuihurBlog/" class="sidebar-heading clickable router-link-active"><span>欢迎学习</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/GuihurBlog/" aria-current="page" class="sidebar-link">学前必读</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/GuihurBlog/technology_sharing/First" class="sidebar-heading clickable open"><span>技术分享</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/GuihurBlog/hello-world/" class="sidebar-link">One</a></li><li><a href="/GuihurBlog/technology_sharing/blog踩坑日志.html" class="sidebar-link">Blog踩坑日志</a></li><li><a href="/GuihurBlog/technology_sharing/了解Flutter.html" class="sidebar-link">了解Flutter</a></li><li><a href="/GuihurBlog/technology_sharing/TOTP原理解析.html" class="sidebar-link">TOTP原理解析</a></li><li><a href="/GuihurBlog/technology_sharing/Vue响应式原理解析.html" class="active sidebar-link">Vue响应式原理解析</a></li><li><a href="/GuihurBlog/technology_sharing/盲打速成.html" class="sidebar-link">盲打速成</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/GuihurBlog/life_detail/template" class="sidebar-heading clickable"><span>生活点滴</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/GuihurBlog/life_detail/template.html" class="sidebar-link">life_one</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/GuihurBlog/play/template" class="sidebar-heading clickable"><span>自娱自乐</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/GuihurBlog/play/template.html" class="sidebar-link">play_one</a></li><li><a href="/GuihurBlog/play/travel_sz.html" class="sidebar-link">深圳之旅</a></li><li><a href="/GuihurBlog/play/太刀修炼.html" class="sidebar-link">太刀修炼</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88></h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">💌纵观全局 -- 俯视代码</h1> <div data-v-8a445198><!----> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1 id="💌纵观全局-俯视代码"><a href="#💌纵观全局-俯视代码" class="header-anchor">#</a> 💌纵观全局 -- 俯视代码</h1> <p><a href="https://www.yuque.com/luffy-j7ldi/yux7yt/nr33g2iuald76dmi" target="_blank" rel="noopener noreferrer">语雀中已公开当前文章 -- 戳这里👈<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ol><li>创建 Vue 类</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Vue</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$data <span class="token operator">=</span> options<span class="token punctuation">.</span>data
    <span class="token function">Observe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">)</span>

    <span class="token comment">// 属性代理</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// console.log('触发 this 上属性的 get 属性')</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newValue
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 调用模板编译的函数</span>
    <span class="token function">compiler</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>el<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>创建 数据劫持方法</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Observe</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj <span class="token operator">||</span> <span class="token keyword">typeof</span> obj <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> value <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token function">Observe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果实例存在的话就将实例添加到数组中</span>
        Dep<span class="token punctuation">.</span>target <span class="token operator">&amp;&amp;</span> dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
        <span class="token comment">// console.log(dep)</span>
        <span class="token keyword">return</span> value
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> newValue
        <span class="token function">Observe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>创建 compiler 方法</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">compiler</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取 el 对应的 dom 元素</span>
  vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>

  <span class="token comment">// 创建文档碎片</span>
  <span class="token keyword">const</span> fragment <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fragment<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 进行模板编译 用一个函数封装起来，包含模板编译的全过程，就暂时不抽离出去了，省一些事</span>
  <span class="token function">replace</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span>

  vm<span class="token punctuation">.</span>$el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span>

  <span class="token comment">// 负责对 dom 模板进行编译  核心中的核心函数</span>
  <span class="token keyword">function</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> regMustache <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\{\{\s*(\S+)\s*\}\}</span><span class="token regex-delimiter">/</span></span> <span class="token comment">//匹配插值表达式的正则表达式</span>
    <span class="token comment">// 判断是否为 文本节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> text <span class="token operator">=</span> node<span class="token punctuation">.</span>textContent
      <span class="token keyword">const</span> regResult <span class="token operator">=</span> regMustache<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>regResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> regResult<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
        node<span class="token punctuation">.</span>textContent <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>regMustache<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> regResult<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token parameter">newValue</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// node.textContent = node.textContent.replace(regResult[0], value)</span>
          node<span class="token punctuation">.</span>textContent <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>regMustache<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 判断是否为 input 节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>tagName<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'INPUT'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 判断是否有 v-model 属性</span>
      <span class="token keyword">const</span> attrs <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>attributes<span class="token punctuation">)</span> <span class="token comment">//伪数组转数组</span>
      <span class="token keyword">const</span> model <span class="token operator">=</span> attrs<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'v-model'</span><span class="token punctuation">)</span> <span class="token comment">//将含有 v-model 的节点的model值选出来 v-model=&quot;name&quot;,字符串格式,不符合的为null</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> valueKey <span class="token operator">=</span> model<span class="token punctuation">.</span>value
        <span class="token keyword">const</span> value <span class="token operator">=</span> valueKey<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
        <span class="token comment">// console.log(value)</span>
        node<span class="token punctuation">.</span>value <span class="token operator">=</span> value <span class="token comment">//现在只是首次编译的时候能同步</span>
        <span class="token comment">// 使用发布订阅模式实现单向绑定</span>
        <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> valueKey<span class="token punctuation">,</span> <span class="token parameter">newValue</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          node<span class="token punctuation">.</span>value <span class="token operator">=</span> newValue
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 取值  按 . 分割之后 再用 slice取到倒数第二个</span>
          <span class="token keyword">const</span> keyArr <span class="token operator">=</span> valueKey<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
          <span class="token keyword">const</span> obj <span class="token operator">=</span> keyArr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> keyArr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newobj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> newobj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span> <span class="token comment">//obj是到 倒数第二个属性</span>
          <span class="token comment">// 赋值 替换</span>
          <span class="token comment">// obj[keyArr.length - 1] = e.target.value</span>
          <span class="token keyword">const</span> leafKey <span class="token operator">=</span> keyArr<span class="token punctuation">[</span>keyArr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment">//取到最后一个属性</span>
          obj<span class="token punctuation">[</span>leafKey<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token comment">//倒数第二个引用倒数第一个 属性,最终得到目标值的位置,替换值就好</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    node<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">replace</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>结合发布订阅者模式</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">//可以优化为 单例模式</span>
  <span class="token punctuation">}</span>
  <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm
    <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key
    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb

    Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span>
    key<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
    Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="💞视频顺序解析模块"><a href="#💞视频顺序解析模块" class="header-anchor">#</a> 💞视频顺序解析模块</h1> <h2 id="🙂创建-vue-类"><a href="#🙂创建-vue-类" class="header-anchor">#</a> 🙂创建 Vue 类</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Vue</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$data <span class="token operator">=</span> options<span class="token punctuation">.</span>data
    <span class="token function">Observe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">)</span>

    <span class="token comment">// 属性代理</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// console.log('触发 this 上属性的 get 属性')</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>$data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newValue
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 调用模板编译的函数</span>
    <span class="token function">compiler</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>el<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <ol><li>首先<strong>创建 Vue 类</strong>，构造函数中传入一个<strong>配置对象</strong>参数，在内部将 data 赋值给 $data</li> <li>调用一下 <strong>Observe 函数</strong>，将 data 对象传入，内部的作用是对 data 中所有的数据进行劫持
<ol><li>后面结合发布订阅模式还 创建了一个 Dep 实例，用于在 触发 get 的时候判断 Dep 类中是否绑定了 watcher 实例，有的话就 执行 addSub 方法，也用于在 set 中值被更新时 调用 notify 去通知所有的订阅者</li></ol></li> <li>通过<strong>属性代理</strong>的方式，为 vm 实例代理上 data 中的数据，是一个便捷方式，通过 this.name 方式 调用原本需要 this.$data.name 调用 的属性</li> <li>最后通过 执行 <strong>compiler 函数</strong>将用户编写的模板进行 模板语言 替换
<ol><li>主要是匹配 mustache 语法 以及 属性中动态绑定的属性值，将这些占位符替换为 data 中的数据</li></ol></li></ol> <p><strong>总结：</strong></p> <ul><li>**主要就是在 new Vue 的实例的同时执行以上五个步骤，为 Vue 实例做初始化，配置参数data的数据劫持以及模板的碎片化文档优化处理 **</li></ul> <h2 id="😄创建-数据劫持-的方法"><a href="#😄创建-数据劫持-的方法" class="header-anchor">#</a> 😄创建 数据劫持 的方法</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Observe</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj <span class="token operator">||</span> <span class="token keyword">typeof</span> obj <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> value <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token function">Observe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// console.log('执行了 get')</span>
        <span class="token comment">// 如果实例存在的话就将实例添加到数组中</span>
        Dep<span class="token punctuation">.</span>target <span class="token operator">&amp;&amp;</span> dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
        <span class="token comment">// console.log(dep)</span>
        <span class="token keyword">return</span> value
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// console.log('执行了 set')</span>
        <span class="token comment">// console.log(newValue)</span>
        value <span class="token operator">=</span> newValue
        <span class="token function">Observe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <ol><li>首先<strong>判断</strong>传入的参数<strong>是否为对象类型</strong>，如果不为对象类型那就直接 return
<ol><li>因为第一次传入的是 data 对象，一定是一个对象，所以这个限制只是作为下面 **递归处理 **时的退出条件，并不影响正常执行</li></ol></li> <li>第一次一定是对象，于是进入到下面的代码，对<strong>这个对象的每一个属性</strong>进行 递归 劫持，主要是在 get 和 set 中要处理 <strong>发布订阅</strong> 的代码，所以才需要劫持
<ol><li>因为 属性的 get 和 set 有当数据被 取 或者 赋值 时就执行函数的特性，非常契合 发布订阅 中的当数据发生变化时 更新模板 中数据的修改，于是被选择使用！（vue3 中的 proxy 也只是替换了 这一功能而已，目的是更多的操作性以及让逻辑更加的合理）</li> <li>get 和 set 的劫持中有一个非常重要的点就是<strong>防止 循环引用</strong>！
<ol><li>get/set 如果在内部重新 引用/赋值，那么就相当于一直触发 get/set</li> <li>解决这一问题的方法是使用 <strong>闭包</strong>，通过在 劫持函数 调用之前，用一个变量存着那个值，之后更新与获取都通过这个值即可</li></ol></li> <li>set 中 为了保证 修改后的 值也能够被劫持到，于是在修改后也要回调一下 Observe 方法，将新的值通过这个函数数据劫持</li></ol></li></ol> <p><img src="https://cdn.nlark.com/yuque/0/2023/png/20359134/1679645866551-1868aaf3-91a1-479c-9a9b-b002986b79ac.png#averageHue=%23242a32&amp;clientId=uc69149a7-9688-4&amp;from=paste&amp;height=340&amp;id=u05b30e39&amp;originHeight=518&amp;originWidth=621&amp;originalType=binary&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;size=72072&amp;status=done&amp;style=none&amp;taskId=ud83bddf0-c75a-4714-9995-4f2834dba15&amp;title=&amp;width=407.5426025390625" alt="image.png"></p> <ol start="3"><li>递归调用的方法非常值得学习，通过数组的 reduce()
<ol><li>两个参数，一个是回调函数，还有一个是初始值，默认为0</li> <li>回调函数内部又需要两个参数，第一个是 上一次循环的返回值，第二个是当前项取得值</li> <li>通过这个方法能够很好的解决 链式调用 的问题（info.name.a ==&gt; 取到 a 的值）</li></ol></li> <li>还有一个后面加入的代码，是一个非常秀的操作：
<ol><li>因为这个函数只会在 Vue 实例创建的那一刻执行，所以内部执行的同时创建一个 Dep 实例作为<strong>全局的 收集者</strong>，然后通过 在 get 和 set 中实现 发布订阅的相关功能</li> <li>get 中每次调用会判断 Dep 类中是否有 watcher 实例，如果有就 插入 全局收集者数组中 ，没有的话就不理会</li> <li>set 中每次触发会修改 data 中对应的值为最新的值，接着触发 notify 方法通知所有订阅者更新数据</li></ol></li></ol> <h2 id="😬创建-compile-模块"><a href="#😬创建-compile-模块" class="header-anchor">#</a> 😬创建 compile 模块</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">compiler</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取 el 对应的 dom 元素</span>
  vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>

  <span class="token comment">// 创建文档碎片</span>
  <span class="token keyword">const</span> fragment <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fragment<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 进行模板编译 用一个函数封装起来，包含模板编译的全过程，就暂时不抽离出去了，省一些事</span>
  <span class="token function">replace</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span>

  vm<span class="token punctuation">.</span>$el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fragment<span class="token punctuation">)</span>

  <span class="token comment">// 负责对 dom 模板进行编译  核心中的核心函数</span>
  <span class="token keyword">function</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> regMustache <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\{\{\s*(\S+)\s*\}\}</span><span class="token regex-delimiter">/</span></span> <span class="token comment">//匹配插值表达式的正则表达式</span>
    <span class="token comment">// 判断是否为 文本节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> text <span class="token operator">=</span> node<span class="token punctuation">.</span>textContent
      <span class="token keyword">const</span> regResult <span class="token operator">=</span> regMustache<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    	<span class="token comment">// 如果匹配的不为空</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>regResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> regResult<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
        node<span class="token punctuation">.</span>textContent <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>regMustache<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> regResult<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token parameter">newValue</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// node.textContent = node.textContent.replace(regResult[0], value)</span>
          node<span class="token punctuation">.</span>textContent <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>regMustache<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 判断是否为 input 节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>tagName<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'INPUT'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 判断是否有 v-model 属性</span>
      <span class="token keyword">const</span> attrs <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>attributes<span class="token punctuation">)</span> <span class="token comment">//伪数组转数组</span>
      <span class="token keyword">const</span> model <span class="token operator">=</span> attrs<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'v-model'</span><span class="token punctuation">)</span> <span class="token comment">//将含有 v-model 的节点的model值选出来 v-model=&quot;name&quot;,字符串格式,不符合的为null</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> valueKey <span class="token operator">=</span> model<span class="token punctuation">.</span>value
        <span class="token keyword">const</span> value <span class="token operator">=</span> valueKey<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
        <span class="token comment">// console.log(value)</span>
        node<span class="token punctuation">.</span>value <span class="token operator">=</span> value <span class="token comment">//现在只是首次编译的时候能同步</span>
        <span class="token comment">// 使用发布订阅模式实现单向绑定</span>
        <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> valueKey<span class="token punctuation">,</span> <span class="token parameter">newValue</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          node<span class="token punctuation">.</span>value <span class="token operator">=</span> newValue
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// 实现双向绑定:就是监听input事件,每次更新input都将data中的值进行一次更新,这一步应该不涉及发布订阅模式 v-model == @input +:value ,:value 和 :v-model 没啥区别,实际上就是用了这里的发布订阅模式</span>
        node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 先获取到要修改的 data 中的值,然后用 input 中的新值替换就好</span>
          <span class="token comment">// 取值  按 . 分割之后 再用 slice取到倒数第二个</span>
          <span class="token keyword">const</span> keyArr <span class="token operator">=</span> valueKey<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
          <span class="token keyword">const</span> obj <span class="token operator">=</span> keyArr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> keyArr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newobj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> newobj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span> <span class="token comment">//obj是到 倒数第二个属性</span>
          <span class="token comment">// 赋值 替换</span>
          <span class="token comment">// obj[keyArr.length - 1] = e.target.value</span>
          <span class="token keyword">const</span> leafKey <span class="token operator">=</span> keyArr<span class="token punctuation">[</span>keyArr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment">//取到最后一个属性</span>
          obj<span class="token punctuation">[</span>leafKey<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token comment">//倒数第二个引用倒数第一个 属性,最终得到目标值的位置,替换值就好</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    node<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">replace</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <p>**Main：compiler **的作用是将用户写好的 模板给提取到 **文档碎片 **中，在这期间对这个模板进行一些 操作，然后将修改好的 模板 添加到给页面的节点中进行渲染
<strong>Think：</strong></p> <ol><li>文档碎片的作用其实<strong>类似于 template 模板标签</strong>一样，可以整个添加回 app 节点中，结构与之前一样。但是<strong>使用 createElement 创建新节点</strong>也是可以的，只不过添加回去 app 节点的时候<strong>得把子节点一个一个地</strong> appendChild 过去，不能直接整体 appendChild ，这样的话就会变得多了一个节点在 app 中，可能会影响样式之类的 !</li> <li>一开始不知道 appendChild 居然是移动元素，也就是会自动删除原节点的对应内容，还去验证了一下。后面看了文档，发现 MDN 文档中写的也是会移动的！就算是学会了一些。（但是后面通过 creatElement 的方式，直接append整体，之后 那个 createElement 的节点还是存在内容的，不知道是不是因为整体移动，所以获取的还是这同一个节点，大概率是的，不然就是文档漏洞了 哈哈哈哈）</li></ol> <p><img src="https://cdn.nlark.com/yuque/0/2023/png/20359134/1679646135054-123754ae-6c9a-4efb-99f8-afbe5f791931.png#averageHue=%23f6f4f2&amp;clientId=uc69149a7-9688-4&amp;from=paste&amp;height=394&amp;id=uc6364613&amp;originHeight=433&amp;originWidth=822&amp;originalType=binary&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;size=44813&amp;status=done&amp;style=none&amp;taskId=u4436ccfb-590f-4d2b-a729-7b1f0180785&amp;title=&amp;width=747.2727110760275" alt="62f1f9e4c03c9908e2e1e89753981dc.png"> <strong>Study：</strong></p> <ol><li><strong>前言：</strong> <ol><li>用到了不少自己不熟悉的 api ，值得学习：<strong>createDocumentFragment</strong> 、 <strong>appendChild</strong> 、 <strong>node.firstChild</strong> 、** node.nodeType** 、** node.childNodes** -- 返回值是 nodelist 类型的数组 、文本节点有一个属性：<strong>textContent</strong> 是真正的文本，<strong>文本节点也是一个对象</strong>。</li> <li>双向数据绑定中也涉及了：<strong>node.nodeType</strong>、<strong>node.tagName</strong>、<strong>Array.from</strong>、<strong>attrs.find</strong>、 <strong>keyArr.slice</strong>，作用各不相同，但是都比较考验功底。因为有很多字符串和数组的方法，作用都挺像的，看自己怎么选择！</li></ol></li> <li>💥首先是参数，需要获取 el 和 vm ，也就是拿到 Vue 实例以及挂载的节点</li> <li>💥接着是获取到对应的节点，创建 文档碎片 后将节点内的元素都加入到 文档碎片 中</li> <li><strong>🗯️🤠【重点中的重点】</strong>：通过 <strong>replace 函数</strong> 对 文档碎片中 的 节点 进行处理，以达到我们最终想要的效果：
<ol><li>将 模板 中的 占位符 替换为 data 中的内容，接着使用 发布订阅 以及 数据劫持 对 data 中的每一个元素进行 监听，当发现数据变化后就更新 模板 的内容</li> <li>【思考🕵️】看了这个 更新模板 的代码，发现根据 data 中数据修改，它修改的是 文档碎片 中的 模板内容，通过代码把模板替成真正的内容之后就把整个 文档碎片 移动到 #app 节点中了。那么如果数据又发生修改，是直接修改 html 页面中的内容实现实现重排，还是又将所有的加入到文档碎片重新编译一次呢？
<ol><li>自己解答：首先是不会重新加入到文档碎片的，因为没有重新调用 compiler 函数</li> <li>其次更新内容的理论是：根据 data 中的数据变化，触发 set ，然后 set 去调用 订阅者实例的 updated 方法</li> <li>updated 方法的作用是获取更新后的值，然后将这个值传递给 cb 回调函数进行更新</li> <li>cb 回调函数的作用就是我想问的问题的关键了：cb 内部有形成一个闭包，可以拿到这个实例对应的 node 节点，将这个 node 节点的 textContent 的占位符 替换为 最新的值，通过这种方式完成数据的更新</li></ol></li> <li>【继续思考🕵️】很好，上一个问题算是解决了，又来一个问题：既然第一次就将占位符替换为内容，并且渲染好了，那么修改数据之后，watcher 内部还是 通过替换 regMustache 为 最新的值，问题是还匹配得到这个 regMustache 吗？是怎么匹配到的？</li></ol></li> <li>💥编译完成后通过 <code>vm.$el.appendChild(fragment)</code> <strong>将文档碎片插入回 #app 节点</strong>中进行渲染！！！</li></ol> <p><img src="https://cdn.nlark.com/yuque/0/2023/png/20359134/1679639107294-34e84687-377a-4f16-9bf8-25a1e07dcc8c.png#averageHue=%23242932&amp;clientId=uc69149a7-9688-4&amp;from=paste&amp;height=445&amp;id=u2a9ab429&amp;originHeight=489&amp;originWidth=977&amp;originalType=binary&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;size=89078&amp;status=done&amp;style=none&amp;taskId=u77bfe754-83fe-40dd-92d0-8c524c83191&amp;title=&amp;width=888.1817989309961" alt="image.png"></p> <hr> <ol start="6"><li>👹replace 方法中的<strong>具体流程</strong>：
<ol><li>首先是设置了一个<strong>匹配 Mustache</strong> 的<strong>正则表达式</strong></li> <li>接着判断 nodeType** 筛选出 文本节点**，然后通过 <strong>占位符</strong> 的内容 找到 data 中对应的数据，然后使用这个数据 **替换 **掉那个占位符</li> <li>最后 将这段 <strong>更新数据的代码</strong> 作为 watcher 实例的<strong>回调函数 的内容</strong>，创建一个 watcher 实例对象
<ol><li>这个实例对象一创建就会执行构造函数中对应的函数，最终的目的是这个 watcher 会被收集者管理起来，当这个节点中的数据对应的** data 中的数据发生变化<strong>会触发这个 watcher 的回调函数对 模板 进行更新，实现</strong>单向数据绑定**</li></ol></li></ol></li> <li>👺上一点中是讲匹配 插值表达式 的，我们还对** input 表单**也做了一个类似的处理
<ol><li>💖首先也是判断 nodeType 类型选出 input 节点</li> <li>接着将具有 v-model 属性的节点再筛选出来</li> <li>拿到 v-model 对应的 占位符，通过这个去索引 data 中对应的内容</li> <li>💖拿到 data 中对应的内容后 替换掉 input 节点的 value 值</li> <li>💖同样的，为了能够实现单向数据绑定，让 data 中对应的值修改时，input 中的 value 也对应的修改，我们也要创建一个 watcher 实例，并且将<strong>这个 替换内容 的操作</strong>作为 cb 回调函数的内容</li> <li><strong>tips</strong>：写到这里我突然明白了，<strong>数据劫持 <strong>是对 data 中的数据进行劫持，当 data 中的数据发生变化的时候，会触发对应的 get 和 set 操作。而 <strong>发布订阅模式</strong> 就是让触发 set 操作的时候，对模板中的数据内容进行更新。所以</strong>单向数据绑定也就是 data 中的内容发生变化的同时去修改模板中的内容，实现实时更新！！！</strong></li></ol></li> <li>对于 input 表单只实现 单向数据绑定 只能说是熟悉了一遍 原理方法，本质和 mustache 的单向数据绑定没啥区别，但是 表单 的<strong>双向数据绑定</strong>就是一个新一些的知识了，不算难但是蛮考验功底的！
<ol><li>😺首先是对当前节点进行 input 事件监听，回调函数中传一个 e，可以拿到 表单中的 新值</li> <li>😺其次是在回调函数中通过找到<strong>要更新数据的位置</strong>，这一步比较特殊：通过 v-model 的占位符去匹配 倒数第二个对象！（有点绕，但是原理很好理解，例如： obj.info.name,我们要修改 name ，那么就要拿到 obj.info ，然后通过 obj.info[name] 的方式去修改值）</li> <li>😺匹配到之后 将 位置上的值 替换为 新值 就好了</li></ol></li> <li>如果没有匹配到 文本节点 以及 input 节点的话，那么就一定是内部还有子节点，通过遍历 node.childNodes 的方式进行 <strong>replace 递归</strong> <ol><li><strong>不用担心会死循环</strong>，因为最后一个节点一定会是 文本节点，这个 nodeType 将空白符如换行、空格也当成了 空白符</li></ol></li></ol> <p><img src="https://cdn.nlark.com/yuque/0/2023/png/20359134/1679639142557-a8fb4965-8468-448a-8f42-eeb14d5136ff.png#averageHue=%23242a32&amp;clientId=uc69149a7-9688-4&amp;from=paste&amp;height=320&amp;id=uc0ebcc68&amp;originHeight=352&amp;originWidth=945&amp;originalType=binary&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;size=58049&amp;status=done&amp;style=none&amp;taskId=u58cfde09-372f-4bdf-80b1-d24f9887042&amp;title=&amp;width=859.0908904706155" alt="image.png"></p> <h2 id="😍创建-收集者类-以及-订阅者-类"><a href="#😍创建-收集者类-以及-订阅者-类" class="header-anchor">#</a> 😍创建 收集者类 以及 订阅者 类</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 创建收集者类</span>
<span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">//可以优化为 单例模式</span>
  <span class="token punctuation">}</span>
  <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建订阅者类</span>
<span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm
    <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key
    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb

    Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span>
    key<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
    Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <ol><li>收集者类内部实际就<strong>管理三个东西</strong>，基本上不需要修改里面的代码
<ol><li>一个管理订阅者的数组，一般来说全局只能有一个，可以使用单例模式优化一下代码，防止创建 Dep 实例的时候又创建一个 数组；一个是 添加 Watcher 实例 的方法；一个是 发布通知 的方法</li></ol></li></ol> <p><img src="https://cdn.nlark.com/yuque/0/2023/png/20359134/1679639403710-63b0a336-fa63-46e3-9593-b1a3859fe526.png#averageHue=%23232931&amp;clientId=uc69149a7-9688-4&amp;from=paste&amp;height=218&amp;id=uac56eb46&amp;originHeight=386&amp;originWidth=603&amp;originalType=binary&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;size=37440&amp;status=done&amp;style=none&amp;taskId=u51571ae7-2b4b-4cec-84c5-6b3e8797767&amp;title=&amp;width=341.1647644042969" alt="image.png"></p> <ol start="2"><li>订阅者类内部有一些比较牛的技巧：
<ol><li>需要传入三个参数：vue实例，对应元素的 key(可能是 obj.info.name 这种形式，就是占位符嘛)，还有一个回调函数，用于当数据更新的时候执行的。<strong>这个回调函数需要什么参数是在 watcher 实例被创建的时候定义的，与类的定义无关</strong></li> <li>**三行精彩的代码实现 **订阅者实例被添加到 收集者的数组中
<ol><li><strong>第一行💘</strong>：作用是让当前的 watcher 实例绑定到 Dep 类的类属性中，其目的实际上就是传参，让这个实例尽量成为顶层对象的属性，好让顶层对象下面的其他对象取值判断是否存在该值。这样的方式其他地方也有见过，类似的有通过原型链的继承方式，将公共的代码放在原型中作为共用</li> <li><strong>第二行💘</strong>：作用是获取 data 中对应的值，触发它的 getter 方法；这个 getter 方法内部会判断 Dep 上是否绑定了 target ，如果绑定了就将此值插入到 dep 实例的数组中 （巧妙之处就在这）</li> <li><strong>第三行💘</strong>：这一操作的目的就是让 watcher 实例被创建的同时将它传入 收集者数组，目的达到之后，这个 target 就可以从 Dep 中删除了，以免对后续 getter 的调用造成干扰</li> <li><strong>疑惑</strong>🗯️🗯️：可能会产生一个困惑，随便取一个数，只要触发 getter 不就好了吗？既然 触发 getter 就一定会检查 Dep 上是否有 getter，那为什么一定要索引到 key 表示的最里面的元素呢？</li> <li><strong>解答：</strong></li></ol></li></ol></li></ol> <blockquote><div class="language- extra-class"><pre><code>     1. 确实，单从这个代码来看，是只要触发 getter 就判断是否存在实例。但是这只是简单的发布订阅模式，为了让我们更好地理解 vue 的深层次原理才没有将发布订阅写的那么完美，真要探究，那么 depSub 数组可能就是以对象的形式存在了，通过 key 保存 订阅对象，每一个订阅对象的值都是数组，存放一个个回调，这时候就不是简单的在 get 中 push 一个实例就好了，说不定得判断数组中是否有对应绑定的 key，然后将实例插入。
</code></pre></div></blockquote> <hr> <blockquote><div class="language- extra-class"><pre><code>     2. 补充：这个回答**可能只是引出了 发布订阅 的不完善**，并没有给出一个完美的完善方法，同时**可能也没有解决问题中 “只要触发 getter 就好了”这个问题**，但我认为在发布订阅模式完善的过程中会涉及到这一个点的。如果完善了也没有涉及到，那么确实可以想个方法不让 watcher 构造器去索引对应的值，而是存一个 能够触发 getter 的变量，每次创建实例的时候获取一下这个 getter 。！！甚至直接在 watcher 内部调用 addSub 的方法，创建实例了就直接被收集起来！！！（为什么不呢？我认为挺省事的，为什么要在 getter 中触发呢？）（又来一个问题，我暂时不想再解答了）
</code></pre></div></blockquote> <p><img src="https://cdn.nlark.com/yuque/0/2023/png/20359134/1679642897941-3f5bbcd0-dde7-46ad-b0b8-dfa1c5f9ab09.png#averageHue=%23232930&amp;clientId=uc69149a7-9688-4&amp;from=paste&amp;height=272&amp;id=uabf15e4a&amp;originHeight=299&amp;originWidth=1352&amp;originalType=binary&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;size=55173&amp;status=done&amp;style=none&amp;taskId=u6aaf915c-193f-42e9-ac83-059b1d18111&amp;title=&amp;width=1229.0908824510816" alt="image.png"></p> <hr> <p><img src="https://cdn.nlark.com/yuque/0/2023/png/20359134/1679643812646-b9028909-b7c5-4484-b3f3-09cfe4296d13.png#averageHue=%23232830&amp;clientId=uc69149a7-9688-4&amp;from=paste&amp;height=692&amp;id=ufe6446eb&amp;originHeight=761&amp;originWidth=1102&amp;originalType=binary&amp;ratio=1.100000023841858&amp;rotation=0&amp;showTitle=false&amp;size=114637&amp;status=done&amp;style=none&amp;taskId=u8b2f3cb0-a842-47d1-9f77-97183191c8c&amp;title=&amp;width=1001.818160104358" alt="image.png"></p> <div class="language- extra-class"><pre><code>  3. 最后，除了构造器，还有一个** update 实例方法**：
     1. 首先是 通过 创建实例的时候 传入的 vm 和 key 获取到 data 中保存的值（因为 update 的触发是在 setter 中，且 是更新完数据之后，所以**拿到的一定是更新之后的数据**，最新值）
     2. 接着是**调用当前实例的 cb 回调函数**，并且将新值传入，**进而实现 单向数据绑定**！！！就是调用了一下 cb（newValue），内部对 模板中的数据进行替换，实现了单向数据绑定！！！
</code></pre></div><h1 id="💟总结"><a href="#💟总结" class="header-anchor">#</a> 💟总结</h1> <ol><li>😹😹😹这次学习中花了<strong>三天</strong>时间，包括：看视频、手敲、做笔记</li> <li>✋✋✋学习到的：
<ol><li>通过类的方式实现简单的发布订阅模式，之前是通过 调用 收集者内的 on() 和 emit() 方法实现的</li> <li>学习过程分为四个阶段，首先是学习了 <strong>数据劫持模块和属性代理（劫持 get 和 set）</strong>， 其次是学习了** compiler 编译模块（页面一渲染能将模板渲染为对应内容）<strong>，再次是结合 发布订阅 实现了</strong>数据的单向绑定（修改 data 中的数据页面也会跟着 修改）**，最后是实现了 <strong>input 的双向绑定</strong></li> <li>通过 reduce 的方法对 链式引用 取值的妙用，让自己掌握了 reduce 的用法，下次可以去试试写一个 数组扁平化 源代码了！！！</li> <li>对 Object.definedProperty 这个方法更加理解了，用的多了就熟悉了</li> <li>对于一些 HTML 节点的使用也更熟悉一些了，发现了之前自己对 DOM 元素的获取这一块欠缺很大，几乎没有使用过，例如 <strong>nodeType</strong>、<strong>createDocumentFragment</strong>、<strong>node.attributes</strong> 等等</li> <li>也通过这次彬哥的教学方式有所启发：
<ol><li>彬哥是先把必须要掌握的知识先讲一遍，并且引出很恰当的使用场景（结合 Vue），很好理解</li> <li>接着是慢慢引入一个个的<strong>模块</strong>讲解，只讲一下这样做的作用，让我们能够理解这样做能干什么，很少讲为什么要这样做</li> <li>这样子将完整的双向数据绑定实现之后，我能够感觉到很大震撼的操作（虽然中间很多操作不知道为什么要这样做，但是能够知道按照老师这样做能有什么效果），最终激发我的兴趣一点点实践！</li> <li>最终在手敲代码的时候会<strong>自己思考</strong>：为什么这里要这样做？这样做考虑了哪些细节？有的地方是不是考虑的不是特别好，可以完善（例如单例模式的收集者）？之前的知识点是不是也有这样做的例子（关联以前的知识点，例如 Dep 中绑定 Watcher 实例 <strong>类比</strong> <strong>原型方式的继承</strong>）？等等一系列的思考都是在实践中得来的。虽然过程很花时间，但是收获算是蛮大的，对于接下来学习 Vue 的原理或许会有很大的帮助！！！</li></ol></li></ol></li> <li>💯💯💯希望之后能不怕麻烦，多看看这篇 文章，实现完全理解 Vue 双向绑定原理，手写都能写出来吧！！！</li></ol></div></section> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/Xguihur/GuihurBlog.git/edit/master/technology_sharing/Vue响应式原理解析.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2024/2/27 上午12:49:40</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/GuihurBlog/technology_sharing/TOTP原理解析.html" class="prev">
          TOTP原理解析
        </a></span> <span class="next"><a href="/GuihurBlog/technology_sharing/盲打速成.html">
          盲打速成
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/GuihurBlog/technology_sharing/Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90.html#🙂创建-vue-类" class="sidebar-link reco-side-🙂创建-vue-类" data-v-b57cc07c>🙂创建 Vue 类</a></li><li class="level-2" data-v-b57cc07c><a href="/GuihurBlog/technology_sharing/Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90.html#😄创建-数据劫持-的方法" class="sidebar-link reco-side-😄创建-数据劫持-的方法" data-v-b57cc07c>😄创建 数据劫持 的方法</a></li><li class="level-2" data-v-b57cc07c><a href="/GuihurBlog/technology_sharing/Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90.html#😬创建-compile-模块" class="sidebar-link reco-side-😬创建-compile-模块" data-v-b57cc07c>😬创建 compile 模块</a></li><li class="level-2" data-v-b57cc07c><a href="/GuihurBlog/technology_sharing/Vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90.html#😍创建-收集者类-以及-订阅者-类" class="sidebar-link reco-side-😍创建-收集者类-以及-订阅者-类" data-v-b57cc07c>😍创建 收集者类 以及 订阅者 类</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/GuihurBlog/assets/js/app.8bb8757a.js" defer></script><script src="/GuihurBlog/assets/js/7.f1c26474.js" defer></script><script src="/GuihurBlog/assets/js/2.70e4b6cf.js" defer></script><script src="/GuihurBlog/assets/js/1.e850f610.js" defer></script><script src="/GuihurBlog/assets/js/47.0951090b.js" defer></script>
  </body>
</html>
